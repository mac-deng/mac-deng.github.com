<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>mac's blog</title>
  <meta name="author" content="mac">
  
  <meta name="description" content="some Experience">
  
  
  <meta name="viewport" content="width=device-width; initial-scale=1; maximum-scale=1">

  
  <meta property="og:site_name" content="mac's blog"/>

  <link rel="alternate" href="/atom.xml" title="mac's blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-34831704-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</head>

<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">mac's blog</a></h1>
  <h2><a href="/">share Experience</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">


  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-02-28T02:55:06.000Z"><a href="/2013/02/28/node-bigpipe/">Feb 28 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/02/28/node-bigpipe/">用 node.js 实现 BigPipe</a></h1>
  

    </header>
    <div class="entry">
      
        <div class="entry-content"><p>BigPipe 是 Facebook 开发的优化网页加载速度的技术。网上几乎没有用 node.js 实现的文章，实际上，不止于 node.js，BigPipe 用其他语言的实现在网上都很少见。以至于这技术出现很久以后，我还以为就是整个网页的框架先发送完毕后，用另一个或几个 ajax 请求再请求页面内的模块。直到不久前，我才了解到原来 BigPipe 的核心概念就是只用一个 HTTP 请求，只是页面元素不按顺序发送而已。</p>

<p>了解了这个核心概念就好办了，得益于 node.js 的异步特性，很容易就可以用 node.js 实现 BigPipe。本文会一步一步详尽地用例子来说明 BigPipe 技术的起因和一个基于 node.js 的简单实现。</p>

<p>我会用 express 来演示，简单起见，我们选用 jade 作为模版引擎，并且我们不使用引擎的子模版（partial）特性，而是以子模版渲染完成以后的 HTML 作为父模版的数据。</p>

<p>先建一个 nodejs-bigpipe 的文件夹，写一个 package.json 文件如下：</p>

<pre><code>{
    &quot;name&quot;: &quot;bigpipe-experiment&quot;
  , &quot;version&quot;: &quot;0.1.0&quot;
  , &quot;private&quot;: true
  , &quot;dependencies&quot;: {
        &quot;express&quot;: &quot;3.x.x&quot;
      , &quot;consolidate&quot;: &quot;latest&quot;
      , &quot;jade&quot;: &quot;latest&quot;
    }
}
</code></pre>

<p>运行 npm install 安装这三个库，consolidate 是用来方便调用 jade 的。</p>

<p>先做个最简单的尝试，两个文件：</p>

<p>app.js:</p>

<pre><code>var express = require(&#39;express&#39;)
  , cons = require(&#39;consolidate&#39;)
  , jade = require(&#39;jade&#39;)
  , path = require(&#39;path&#39;)

var app = express()

app.engine(&#39;jade&#39;, cons.jade)
app.set(&#39;views&#39;, path.join(<strong>dirname, &#39;views&#39;))
app.set(&#39;view engine&#39;, &#39;jade&#39;)

app.use(function (req, res) {
  res.render(&#39;layout&#39;, {
      s1: &quot;Hello, I&#39;m the first section.&quot;
    , s2: &quot;Hello, I&#39;m the second section.&quot;
  })
})

app.listen(3000)
</code></pre>

<p>views/layout.jade</p>

<pre><code>doctype html

head
  title Hello, World!
  style
    section {
      margin: 20px auto;
      border: 1px dotted gray;
      width: 80%;
      height: 150px;
    }

section#s1!=s1
section#s2!=s2
</code></pre>

<p>效果如下：</p>

<p><img src="https://raw.github.com/undozen/bigpipe-on-node/master/screenshot/1.png" alt="screenshot 1"></p>

<p>接下来我们把两个 section 模版放到两个不同的模版文件里：</p>

<p>views/s1.jade:</p>

<pre><code>h1 Partial 1
.content!=content
</code></pre>

<p>views/s2.jade:</p>

<pre><code>h1 Partial 2
.content!=content
</code></pre>

<p>在 layout.jade 的 style 里增加一些样式</p>

<pre><code>section h1 {
  font-size: 1.5;
  padding: 10px 20px;
  margin: 0;
  border-bottom: 1px dotted gray;
}
section div {
  margin: 10px;
}
</code></pre>

<p>将 app.js 的 app.use() 部分更改为：</p>

<pre><code>var temp = {
    s1: jade.compile(fs.readFileSync(path.join(</strong>dirname, &#39;views&#39;, &#39;s1.jade&#39;)))
  , s2: jade.compile(fs.readFileSync(path.join(<strong>dirname, &#39;views&#39;, &#39;s2.jade&#39;)))
}
app.use(function (req, res) {
  res.render(&#39;layout&#39;, {
      s1: temp.s1({ content: &quot;Hello, I&#39;m the first section.&quot; })
    , s2: temp.s2({ content: &quot;Hello, I&#39;m the second section.&quot; })
  })
})
</code></pre>

<p>之前我们说“以子模版渲染完成以后的 HTML 作为父模版的数据”，指的就是这样，<code>temp.s1</code> 和 <code>temp.s2</code> 两个方法会生成 s1.jade 和 s2.jade 两个文件的 HTML 代码，然后把这两段代码作为 layout.jade 里面 s1、s2 两个变量的值。</p>

<p>现在页面看起来是这样子：</p>

<p><img src="https://raw.github.com/undozen/bigpipe-on-node/master/screenshot/2.png" alt="screenshot 2"></p>

<p>一般来说，两个 section 的数据是分别获取的——不管是通过查询数据库还是 RESTful 请求，我们用两个函数来模拟这样的异步操作。</p>

<pre><code>var getData = {
    d1: function (fn) {
        setTimeout(fn, 3000, null, { content: &quot;Hello, I&#39;m the first section.&quot; })
    }
  , d2: function (fn) {
        setTimeout(fn, 5000, null, { content: &quot;Hello, I&#39;m the second section.&quot; })
    }
}
</code></pre>

<p>这样一来，app.use() 里的逻辑就会比较复杂了，最简单的处理方式是：</p>

<pre><code>app.use(function (req, res) {
  getData.d1(function (err, s1data) {
    getData.d2(function (err, s2data) {
      res.render(&#39;layout&#39;, {
          s1: temp.s1(s1data)
        , s2: temp.s2(s2data)
      })
    })
  })
})
</code></pre>

<p>这样也可以得到我们想要的结果，但是这样的话，要足足 8 秒才会返回。</p>

<p><img src="https://raw.github.com/undozen/bigpipe-on-node/master/screenshot/3.png" alt="8s"></p>

<p>其实实现逻辑可以看出 getData.d2 是在 getData.d1 的结果返回后才开始调用，而它们两者并没有这样的依赖关系。我们可以用如 async 之类的处理 JavaScript 异步调用的库来解决这样的问题，不过我们这里就简单手写吧：</p>

<pre><code>app.use(function (req, res) {
  var n = 2
    , result = {}
  getData.d1(function (err, s1data) {
    result.s1data = s1data
    --n || writeResult()
  })
  getData.d2(function (err, s2data) {
    result.s2data = s2data
    --n || writeResult()
  })
  function writeResult() {
    res.render(&#39;layout&#39;, {
        s1: temp.s1(result.s1data)
      , s2: temp.s2(result.s2data)
    })
  }
})
</code></pre>

<p>这样就只需 5 秒。</p>

<p><img src="https://raw.github.com/undozen/bigpipe-on-node/master/screenshot/4.png" alt="5s"></p>

<p>在接下来的优化之前，我们加入 jquery 库并把 css 样式放到外部文件，顺便，把之后我们会用到的浏览器端使用 jade 模板所需要的 runtime.js 文件也加入进来，在包含 app.js 的目录下运行：</p>

<pre><code>mkdir static
cd static
curl <a href="http://code.jquery.com/jquery-1.8.3.min.js">http://code.jquery.com/jquery-1.8.3.min.js</a> -o jquery.js
ln -s ../node_modules/jade/runtime.min.js jade.js
</code></pre>

<p>并且把 layout.jade 中的 style 标签里的代码拿出来放到 static/style.css 里，然后把 head 标签改为：</p>

<pre><code>head
  title Hello, World!
  link(href=&quot;/static/style.css&quot;, rel=&quot;stylesheet&quot;)
  script(src=&quot;/static/jquery.js&quot;)
  script(src=&quot;/static/jade.js&quot;)
</code></pre>

<p>在 app.js 里，我们把它们两者的下载速度都模拟为两秒，在<code>app.use(function (req, res) {</code>之前加入：</p>

<pre><code>var static = express.static(path.join(</strong>dirname, &#39;static&#39;))
app.use(&#39;/static&#39;, function (req, res, next) {
  setTimeout(static, 2000, req, res, next)
})
</code></pre>

<p>受外部静态文件的影响，我们的页面现在的加载时间为 7 秒左右。</p>

<p><img src="https://raw.github.com/undozen/bigpipe-on-node/master/screenshot/5.png" alt="7s"></p>

<p>如果我们一收到 HTTP 请求就把 head 部分返回，然后两个 section 等到异步操作结束后再返回，这是利用了 HTTP 的<a href="https://zh.wikipedia.org/wiki/%E5%88%86%E5%9D%97%E4%BC%A0%E8%BE%93%E7%BC%96%E7%A0%81">分块传输编码</a>机制。在 node.js 里面只要使用 res.write() 方法就会自动加上 <code>Transfer-Encoding: chunked</code> 这个 header 了。这样就能在浏览器加载静态文件的同时，node 服务器这边等待异步调用的结果了，我们先删除 layout.jade 中的这 section 这两行：</p>

<pre><code>section#s1!=s1
section#s2!=s2
</code></pre>

<p>因此我们在 res.render() 里也不用给 { s1: …, s2: … } 这个对象，并且因为 res.render() 默认会调用 res.end()，我们需要手动设置 render 完成后的回调函数，在里面用 res.write() 方法。layout.jade 的内容也不必在 writeResult() 这个回调函数里面，我们可以在收到这个请求时就返回，注意我们手动添加了 content-type 这个 header：</p>

<pre><code>app.use(function (req, res) {
  res.render(&#39;layout&#39;, function (err, str) {
    if (err) return res.req.next(err)
    res.setHeader(&#39;content-type&#39;, &#39;text/html; charset=utf-8&#39;)
    res.write(str)
  })
  var n = 2
  getData.d1(function (err, s1data) {
    res.write(&#39;&lt;section id=&quot;s1&quot;&gt;&#39; + temp.s1(s1data) + &#39;&lt;/section&gt;&#39;)
    --n || res.end()
  })
  getData.d2(function (err, s2data) {
    res.write(&#39;&lt;section id=&quot;s2&quot;&gt;&#39; + temp.s2(s2data) + &#39;&lt;/section&gt;&#39;)
    --n || res.end()
  })
})
</code></pre>

<p>现在最终加载速度又回到大概 5 秒左右了。实际运行中浏览器先收到 head 部分代码，就去加载三个静态文件，这需要两秒时间，然后到第三秒，出现 Partial 1 部分，第 5 秒出现 Partial 2 部分，网页加载结束。就不给截图了，截图效果和前面 5 秒的截图一样。</p>

<p>但是要注意能实现这个效果是因为 getData.d1 比 getData.d2 快，也就是说，先返回网页中的哪个区块取决于背后的接口异步调用结果谁先返回，如果我们把 getData.d1 改成 8 秒返回，那就会先返回 Partial 2 部分，s1 和 s2 的顺序对调，最终网页的结果就和我们的预期不符了。</p>

<p><img src="https://raw.github.com/undozen/bigpipe-on-node/master/screenshot/6.png" alt="8s order is not right"></p>

<p>这个问题最终将我们引导到 BigPipe 上来，<strong>BigPipe 就是能让网页各部分的显示顺序与数据的传输顺序解耦的技术</strong>。</p>

<p>其基本思路就是，首先传输整个网页大体的框架，需要稍后传输的部分用空 div（或其他标签）表示：</p>

<pre><code>res.render(&#39;layout&#39;, function (err, str) {
  if (err) return res.req.next(err)
  res.setHeader(&#39;content-type&#39;, &#39;text/html; charset=utf-8&#39;)
  res.write(str)
  res.write(&#39;&lt;section id=&quot;s1&quot;&gt;&lt;/section&gt;&lt;section id=&quot;s2&quot;&gt;&lt;/section&gt;&#39;)
})
</code></pre>

<p>然后将返回的数据用 JavaScript 写入</p>

<pre><code>getData.d1(function (err, s1data) {
  res.write(&#39;&lt;script&gt;$(&quot;#s1&quot;).html(&quot;&#39; + temp.s1(s1data).replace(/&quot;/g, &#39;\&quot;&#39;) + &#39;&quot;)&lt;/script&gt;&#39;)
  --n || res.end()
})
</code></pre>

<p>s2 的处理与此类似。这时你会看到，请求网页的第二秒，出现两个空白虚线框，第五秒，出现 Partial 2 部分，第八秒，出现 Partial 1 部分，网页请求完成。</p>

<p>至此，我们就完成了一个最简单的 BigPipe 技术实现的网页。</p>

<p>需要注意的是，要写入的网页片段有 script 标签的情况，如将 s1.jade 改为</p>

<pre><code>h1 Partial 1
.content!=content
script
  alert(&quot;alert from s1.jade&quot;)
</code></pre>

<p>然后刷新网页，会发现这句 alert 没有执行，而且网页会有错误。查看源代码，知道是因为 <code>&lt;script&gt;</code> 里面的字符串出现 <code>&lt;/script&gt;</code> 而导致的错误，只要将其替换为 <code>&lt;\/script&gt;</code> 即可</p>

<pre><code>res.write(&#39;&lt;script&gt;$(&quot;#s1&quot;).html(&quot;&#39; + temp.s1(s1data).replace(/&quot;/g, &#39;\&quot;&#39;).replace(/&lt;\/script&gt;/g, &#39;&lt;\/script&gt;&#39;) + &#39;&quot;)&lt;/script&gt;&#39;)
</code></pre>

<p>以上我们便说明了 BigPipe 的原理和用 node.js 实现 BigPipe 的基本方法。而在实际中应该怎样运用呢？下面提供一个简单的方法，仅供抛砖引玉，代码如下：</p>

<pre><code>var resProto = require(&#39;express/lib/response&#39;)
resProto.pipe = function (selector, html, replace) {
  this.write(&#39;&lt;script&gt;&#39; + &#39;$(&quot;&#39; + selector + &#39;&quot;).&#39; +
    (replace === true ? &#39;replaceWith&#39; : &#39;html&#39;) +
    &#39;(&quot;&#39; + html.replace(/&quot;/g, &#39;\&quot;&#39;).replace(/&lt;\/script&gt;/g, &#39;&lt;\/script&gt;&#39;) +
    &#39;&quot;)&lt;/script&gt;&#39;)
}
function PipeName (res, name) {
  res.pipeCount = res.pipeCount || 0
  res.pipeMap = res.pipeMap || {}
  if (res.pipeMap[name]) return
  res.pipeCount++
  res.pipeMap[name] = this.id = [&#39;pipe&#39;, Math.random().toString().substring(2), (new Date()).valueOf()].join(&#39;_&#39;)
  this.res = res
  this.name = name
}
resProto.pipeName = function (name) {
  return new PipeName(this, name)
}
resProto.pipeLayout = function (view, options) {
  var res = this
  Object.keys(options).forEach(function (key) {
    if (options[key] instanceof PipeName) options[key] = &#39;&lt;span id=&quot;&#39; + options[key].id + &#39;&quot;&gt;&lt;/span&gt;&#39;
  })
  res.render(view, options, function (err, str) {
    if (err) return res.req.next(err)
    res.setHeader(&#39;content-type&#39;, &#39;text/html; charset=utf-8&#39;)
    res.write(str)
    if (!res.pipeCount) res.end()
  })
}
resProto.pipePartial = function (name, view, options) {
  var res = this
  res.render(view, options, function (err, str) {
    if (err) return res.req.next(err)
    res.pipe(&#39;#&#39;+res.pipeMap[name], str, true)
    --res.pipeCount || res.end()
  })
}
app.get(&#39;/&#39;, function (req, res) {
  res.pipeLayout(&#39;layout&#39;, {
      s1: res.pipeName(&#39;s1name&#39;)
    , s2: res.pipeName(&#39;s2name&#39;)
  })
  getData.d1(function (err, s1data) {
    res.pipePartial(&#39;s1name&#39;, &#39;s1&#39;, s1data)
  })
  getData.d2(function (err, s2data) {
    res.pipePartial(&#39;s2name&#39;, &#39;s2&#39;, s2data)
  })
})
</code></pre>

<p>还要在 layout.jade 把两个 section 添加回来：</p>

<pre><code>section#s1!=s1
section#s2!=s2
</code></pre>

<p>这里的思路是，需要 pipe 的内容先用一个 span 标签占位，异步获取数据并渲染完成相应的 HTML 代码后再输出给浏览器，用 jQuery 的 replaceWith 方法把占位的 span 元素替换掉。</p>

<p>本文的代码在 <a href="https://github.com/undozen/bigpipe-on-node"><a href="https://github.com/undozen/bigpipe-on-node&lt;/a&gt;">https://github.com/undozen/bigpipe-on-node&lt;/a&gt;</a> ，我把每一步做成一个 commit 了，希望你 clone 到本地实际运行并 hack 一下看看。因为后面几步涉及到加载顺序了，确实要自己打开浏览器才能体验到而无法从截图上看到（其实应该可以用 gif 动画实现，但是我懒得做了）。</p>

<p>关于 BigPipe 的实践还有很大的优化空间，比如说，要 pipe 的内容最好设置一个触发的时间值，如果异步调用的数据很快返回，就不需要用 BigPipe，直接生成网页送出即可，可以等到数据请求超过一定时间才用 BigPipe。使用 BigPipe 相比 ajax 既节省了浏览器到 node.js 服务器的请求数，又节省了 node.js 服务器到数据源的请求数。不过具体的优化和实践方法，等到雪球网用上 BigPipe 以后再分享吧。</p>
</div>


  <footer>
    <p class="meta">



<span class="byline author vcard">Posted by <span class="fn">

    <a href="http://xueqiu.com/undozen">安动生</a>

</span></span>













<time datetime="2013-02-27T13:42:00+08:00" pubdate="" data-updated="true">Feb 27<span>th</span>, 2013</time>


    </p>

  </footer>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-02-18T08:09:58.000Z"><a href="/2013/02/18/node-util/">Feb 18 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/02/18/node-util/">nodeJS 工具集</a></h1>
  

    </header>
    <div class="entry">
      
        <p>js压缩工具<a href="https://github.com/mishoo/UglifyJS"> UglifyJS  </a></p>
<p>css压缩工具<a href="https://github.com/GoalSmashers/clean-css"> clean-css  </a> </p>
<p>图片压缩工具<a href="https://github.com/colorhook/node-smushit">node-smushit</a> </p>
<p><a href="https://github.com/joyent/node/wiki/modules">模块集合</a> </p>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-02-18T03:08:53.000Z"><a href="/2013/02/18/grunt/">Feb 18 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/02/18/grunt/">grunt 上手（一）</a></h1>
  

    </header>
    <div class="entry">
      
        <p><a href="http://www.gruntjs.com">grunt</a> 是一个基于任务的 JavaScript 项目命令行构建工具。
它有一系列的插件工具能够根据需求、功能划分模块，如何将代码分成多个文件开发，合成一个发布；

</p>
<p>让我们开始安装grunt。

</p>
<p>首先需要<a href="http://nodejs.org/">Nodejs</a>环境，这里假设你已经安装好了<a href="http://nodejs.org/">Nodejs</a>和<a href="https://npmjs.org/">NPM</a>，然后安装grunt

</p>
<p>如果您以前在全局安装过grunt你需要先删除老的grunt。

</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line">npm uninstall -g grunt</div></code></pre></td></tr></table></figure>

<p>然后安装在全局安装cli
</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line">npm install -g grunt-cli</div></code></pre></td></tr></table></figure>

<p>这时候你需要一个Gruntfile.js和package.json文件就可以使grunt简单的工作了。
</p>
<p><p>1.将路径切换到项目下。</p>
</p>
<p><p>2.安装项目所依赖的模块</p><figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line">npm install</div></code></pre></td></tr></table></figure>

</p>
<p>3.运行<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line">grunt</div></code></pre></td></tr></table></figure>

</p>
<p>下面让我们安装<a href="https://github.com/gruntjs/grunt-contrib-cssmin">grunt-contrib-cssmin</a>插件
在项目目录下安装<a href="https://github.com/gruntjs/grunt-contrib-cssmin">grunt-contrib-cssmin</a>
</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line">npm install grunt-contrib-cssmin --save-dev</div></code></pre></td></tr></table></figure>

<p>然后在项目下Gruntfile.js里添加
</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div><div class="line-number">2</div><div class="line-number">3</div><div class="line-number">4</div><div class="line-number">5</div><div class="line-number">6</div><div class="line-number">7</div><div class="line-number">8</div><div class="line-number">9</div><div class="line-number">10</div><div class="line-number">11</div><div class="line-number">12</div><div class="line-number">13</div><div class="line-number">14</div></code></pre></td><td class="code"><pre><code><div class="line"> grunt.initConfig({</div><div class="line">    cssmin: {</div><div class="line">      compress: {</div><div class="line">        files: {</div><div class="line">          <span class="string">"dist/output.css"</span>: [<span class="string">"test/input.css"</span>, <span class="string">"test/input1.css"</span>]</div><div class="line">        }</div><div class="line">      }</div><div class="line">    }</div><div class="line">  });</div><br><div class="line">  grunt.loadNpmTasks(<span class="string">'grunt-contrib-cssmin'</span>);</div><br><div class="line">  grunt.registerTask(<span class="string">'css'</span>, [<span class="string">'cssmin'</span>]);</div><br></code></pre></td></tr></table></figure>

<p>代表要使用这个插件

</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line">grunt.loadNpmTasks(<span class="string">'grunt-contrib-cssmin'</span>);</div></code></pre></td></tr></table></figure>

<p>代表给grunt注册一个css任务来执行cssmin

</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line">  grunt.registerTask(<span class="string">'css'</span>, [<span class="string">'cssmin'</span>]);</div></code></pre></td></tr></table></figure>

<p>然后可以通过<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line">grunt css</div></code></pre></td></tr></table></figure>

</p>
<p>来运行

</p>
<p>如果写成<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line"> grunt.registerTask(<span class="string">'default'</span>, [<span class="string">'cssmin'</span>]);</div></code></pre></td></tr></table></figure>

</p>
<p>则可以直接使用<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line"> grunt </div></code></pre></td></tr></table></figure>

</p>
<p>来运行，将test文件夹的input.css和input1.css合并压缩到dist文件夹output.css。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-02-01T06:51:46.000Z"><a href="/2013/02/01/mongoskin-api/">Feb 1 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/02/01/mongoskin-api/">mongoskin与实例教程</a></h1>
  

    </header>
    <div class="entry">
      
        <p>如果你不熟悉使用MongoDB，我会强烈建议您先通过这个MongoDB的教程，让你知道的基本知识MongoDB的，从Mongoskin能得到什么。
</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line">npm install mongoskin</div></code></pre></td></tr></table></figure>
当您安装Mongoskin，您可能会看到此消息：
</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line">To install <span class="keyword">with</span> C++ bson parser <span class="keyword">do</span> &lt;npm install mongodb --mongodb:native&gt;</div></code></pre></td></tr></table></figure>
不要过分担心。C + +的BSON解析器现在实际上是不赞成使用的JavaScript分析器有了很大的提高。只要忽略该消息。

</p>
<p>下面是一个例子
</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div><div class="line-number">2</div><div class="line-number">3</div><div class="line-number">4</div><div class="line-number">5</div><div class="line-number">6</div></code></pre></td><td class="code"><pre><code><div class="line">$ mongo</div><div class="line">&gt; use rockband</div><div class="line">&gt; db.bands.insert({name: <span class="string">'Hollywood Rose'</span>, members: [<span class="string">'Axl Rose'</span>, <span class="string">'Izzy Stradlin'</span>, <span class="string">'Chris Weber'</span>], year: <span class="number">1984</span>})</div><div class="line">&gt; db.bands.insert({name: <span class="string">'Road Crew'</span>, members: [<span class="string">'Slash'</span>, <span class="string">'Steven Adler'</span>, <span class="string">'Duff McKagan'</span>], year: <span class="number">1984</span>})</div><div class="line">&gt; db.bands.insert({name: <span class="string">'L.A. Guns'</span>, members: [<span class="string">'Tracy Guns'</span>, <span class="string">'Paul Black'</span>, <span class="string">'Mick Cripps'</span>, <span class="string">'Nickey Alexander'</span>], year: <span class="number">1985</span>})</div><div class="line">&gt; db.bands.insert({name: <span class="string">"Velvet Revolver"</span>, members: [<span class="string">'Scott Weiland'</span>, <span class="string">'Slash'</span>, <span class="string">'Dave Kushner'</span>, <span class="string">'Matt Sorum'</span>, <span class="string">'Duff McKagan'</span>], year: <span class="number">2002</span>})</div></code></pre></td></tr></table></figure>
我们在rockband数据库创建了4个数据。

</p>
<p>现在是时候引入 mongokin 脚本了，你这样做。
</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line"><span class="keyword">var</span> db = require(<span class="string">'mongoskin'</span>).db(<span class="string">'localhost:27017/rockband'</span>); </div></code></pre></td></tr></table></figure>
这将创建一个实例连接到MongoDB的，默认情况下它连接到数据库rockband的。我命名实例的数据库，从而保持一致MongoDB的命令行的数据库对象。今后所有的数据库实例的实例，我们就创建了一个参考。

</p>
<p>现在，如果你需要进行身份验证连接到数据库呢？身份验证使用Mongoskin是很容易的，只包括认证creds在这样的实例代码：
</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line"><span class="keyword">var</span> db = require(<span class="string">'mongoskin'</span>).db(<span class="string">'dewey:tehrock@localhost:27017/rockband'</span>);</div></code></pre></td></tr></table></figure>
“dewey”是用户名，“tehrock”是密码。

</p>
<p>本教程的其余部分将显示蒙戈的命令及其等价物在Mongoskin。如果你不知道的MongoDB的基本知识，你可能会发现很难仿效，所以一定要确保你已经通过<a href="http://www.hacksparrow.com/the-mongodb-tutorial.html"> MongoDB </a>的教程。

</p>
<p>查看一个集合中现有数据
</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line">db.bands.find()</div></code></pre></td></tr></table></figure>
在Mongoskin中，是这样的：
</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div><div class="line-number">2</div><div class="line-number">3</div><div class="line-number">4</div></code></pre></td><td class="code"><pre><code><div class="line">db.collection(<span class="string">'bands'</span>).find().toArray(<span class="keyword">function</span>(err, result) {</div><div class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</div><div class="line">    console.log(result);</div><div class="line">});</div></code></pre></td></tr></table></figure>
我们使用的toArray()函数来转换的<a href="https://github.com/guileen/node-mongoskin#skincursor"> Mongoskin </a>对开发人员友好的阵列。
那么，有什么不用toArray()的方法吗？在这里，它是：
</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div><div class="line-number">2</div><div class="line-number">3</div><div class="line-number">4</div><div class="line-number">5</div></code></pre></td><td class="code"><pre><code><div class="line">db.collection(<span class="string">'bands'</span>).find({}, <span class="keyword">function</span>(err, result) {</div><div class="line">    result.each(<span class="keyword">function</span>(err, band) {</div><div class="line">        console.log(band);</div><div class="line">    });</div><div class="line">});</div></code></pre></td></tr></table></figure>
从集合中查找一个列表
</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line">&gt; db.bands.findOne()</div></code></pre></td></tr></table></figure>
在mongiskin里是这样的：
</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div><div class="line-number">2</div><div class="line-number">3</div><div class="line-number">4</div></code></pre></td><td class="code"><pre><code><div class="line">db.collection(<span class="string">'bands'</span>).findOne(<span class="keyword">function</span>(err, result) {</div><div class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</div><div class="line">    console.log(result);</div><div class="line">});</div></code></pre></td></tr></table></figure>
注意：我们不转换上面的列阵，因为结果只有一个。
现在，让我们添加另一个文档的集合：
</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line">&gt; db.bands.insert({name: <span class="string">"Guns N' Roses"</span>, members: [<span class="string">'Axl Rose'</span>, <span class="string">'Slash'</span>, <span class="string">'Izzy Stradlin'</span>, <span class="string">'Matt Sorum'</span>, <span class="string">'Duff McKagan'</span>], year: <span class="number">1986</span>});</div></code></pre></td></tr></table></figure>
同样在mongoskin中：
</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div><div class="line-number">2</div><div class="line-number">3</div><div class="line-number">4</div></code></pre></td><td class="code"><pre><code><div class="line">db.collection(<span class="string">'bands'</span>).insert({name: <span class="string">"Guns N' Roses"</span>, members: [<span class="string">'Axl Rose'</span>, <span class="string">'Slash'</span>, <span class="string">'Izzy Stradlin'</span>, <span class="string">'Matt Sorum'</span>, <span class="string">'Duff McKagan'</span>], year: <span class="number">1986</span>}, <span class="keyword">function</span>(err, result) {</div><div class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</div><div class="line">    <span class="keyword">if</span> (result) console.log(<span class="string">'Added!'</span>);</div><div class="line">});</div></code></pre></td></tr></table></figure>
我需要更换成员Matt Sorum与 Steven Adler。mongodb是这么做的：
</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div><div class="line-number">2</div></code></pre></td><td class="code"><pre><code><div class="line">&gt; db.bands.update({name:<span class="string">"Guns N' Roses"</span>}, {<span class="string">'$pull'</span>:{members:<span class="string">'Matt Sorum'</span>}})</div><div class="line">&gt; db.bands.update({name:<span class="string">"Guns N' Roses"</span>}, {<span class="string">'$push'</span>:{members:<span class="string">'Steven Adler'</span>}})</div></code></pre></td></tr></table></figure>
在Mongoskin中：
</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div><div class="line-number">2</div><div class="line-number">3</div><div class="line-number">4</div><div class="line-number">5</div><div class="line-number">6</div><div class="line-number">7</div></code></pre></td><td class="code"><pre><code><div class="line">db.collection(<span class="string">'bands'</span>).update({name:<span class="string">"Guns N' Roses"</span>}, {<span class="string">'$pull'</span>:{members:<span class="string">'Matt Sorum'</span>}}, <span class="keyword">function</span>(err) {</div><div class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</div><div class="line">    db.collection(<span class="string">'bands'</span>).update({name:<span class="string">"Guns N' Roses"</span>}, {<span class="string">'$push'</span>:{members:<span class="string">'Steven Adler'</span>}}, <span class="keyword">function</span>(err) {</div><div class="line">        <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</div><div class="line">        console.log(<span class="string">'Updated!'</span>);</div><div class="line">    });</div><div class="line">});</div></code></pre></td></tr></table></figure>
现在，让我们在Mongoskin中做一些有条件的选择。
提示：db.collection（&quot;hands&quot;）可以存储在一个变量命名hands中，使我们的Mongoskin代码更精简，让我们这样做：
</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line"><span class="keyword">var</span> bands = db.collection(<span class="string">'bands'</span>);</div></code></pre></td></tr></table></figure>
现在在collection中使用count()函数。
</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div><div class="line-number">2</div></code></pre></td><td class="code"><pre><code><div class="line">&gt; db.bands.count()</div><div class="line">&gt; db.bands.count({year:{$gte:<span class="number">1985</span>}})</div></code></pre></td></tr></table></figure>
在mongoskin：
</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div><div class="line-number">2</div><div class="line-number">3</div><div class="line-number">4</div><div class="line-number">5</div><div class="line-number">6</div><div class="line-number">7</div></code></pre></td><td class="code"><pre><code><div class="line">bands.count(<span class="keyword">function</span>(err, count) {</div><div class="line">    console.log(<span class="string">'There are '</span> + count + <span class="string">' bands in the database'</span>);</div><div class="line">});</div><br><div class="line">bands.count({year:{$gte:<span class="number">1985</span>}}, <span class="keyword">function</span>(err, count) {</div><div class="line">    console.log(count + <span class="string">' bands were formed in 1985 or later'</span>);</div><div class="line">});</div></code></pre></td></tr></table></figure>
这里会查找year大于等于1985数据的数量。
现在，让我们尝试更新文件：
mongo shell： 
</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line">&gt; db.bands.update({name:<span class="string">'Hollywood Rose'</span>}, {$set:{year:<span class="number">1983</span>}})</div></code></pre></td></tr></table></figure>
mongoskin:
</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div><div class="line-number">2</div><div class="line-number">3</div></code></pre></td><td class="code"><pre><code><div class="line">bands.update({name:<span class="string">'Hollywood Rose'</span>}, {$set:{year:<span class="number">2000</span>}}, <span class="keyword">function</span>(err, result) {</div><div class="line">    <span class="keyword">if</span> (!err) console.log(<span class="string">'Year updated!'</span>);</div><div class="line">});</div></code></pre></td></tr></table></figure>
删除一个记录，mongo shell：
</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line">&gt; db.bands.remove({name:<span class="string">'Velvet Revolver'</span>})</div></code></pre></td></tr></table></figure>
mongoskin：
</p>
<p><figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div><div class="line-number">2</div><div class="line-number">3</div></code></pre></td><td class="code"><pre><code><div class="line">db.collection(<span class="string">'bands'</span>).remove({name:<span class="string">'Velvet Revolver'</span>}, <span class="keyword">function</span>(err, result) {</div><div class="line">    <span class="keyword">if</span> (!err) console.log(<span class="string">'VR deleted!'</span>);</div><div class="line">});</div></code></pre></td></tr></table></figure>
在学习mongokin的过程中整理了这个教程。</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-01-31T09:30:54.000Z"><a href="/2013/01/31/editor/">Jan 31 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/01/31/editor/">仅一行代码，打造一个在线编辑器</a></h1>
  

    </header>
    <div class="entry">
      
        <div class="mainContent sep10">
        <p><img src="http://a.36krcnd.com/photo/35cf53371ddaa066da1e68ef0f34f3f4.jpg!heading" alt=""><br>
在大部分人眼里，技术宅给人的印象是沉默寡言，总摸不透他心里想些什么，彼此都保持距离。作为半个程序员，我觉得真正的技术宅大部分时间都在找乐子，鼓捣各种想法，和大部分人的极客心理是一样的，程序员也还爱讲笑话，也喜欢烧菜做饭，虽然大多是为了减减压，这样看来和常人没什么不一样。</p>

<p>不一样的地方，技术宅崇尚极致，喜欢极简，又希望简约不简单，背后就是技术宅满心思的不断的尝试，我正在看着一出好戏在上演：</p>
程序员 Jose Jesus Perez Aguinaga 在 <a target="_blank" data-no-turbolink="true" href="https://coderwall.com/p/lhsrcq">CoderWall</a> 分享了一个小技巧：在浏览器地址栏中输入一行代码：<code>data:text/html, &lt;html contenteditable&gt;</code> ，回车即可把浏览器变临时编辑器（需要浏览器支持 HTML5 属性  contenteditable）。不少程序员受 Jose 的启发，开始对这行代码<a target="_blank" data-no-turbolink="true" href="http://blog.jobbole.com/32823/">加工改造</a>，比如改成支持 Ruby 语法高亮的<a target="_blank" data-no-turbolink="true" href="https://gist.github.com/4666256">编辑器</a>……&quot;</p>

<p> 从引子中可以看到，本来只是简短的小段代码： <code>data:text/html, &lt;html contenteditable&gt;</code>，经过程序员们不断改造，从一个简单的可编辑页面，逐步变成了包括支持 Java、Ruby、Python 等多种 编程语言高亮的代码编辑器，截至不到 1 个小时的最后更新，我已经看到了一个和 <a target="_blank" data-no-turbolink="true" href="http://notepad.cc">notepad.cc</a> 网站功能相近，使用了第三方网站数据库 API 服务存储内容的 <a target="_blank" data-no-turbolink="true" href="https://gist.github.com/4672169">在线编辑器</a> 了：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div><div class="line-number">2</div><div class="line-number">3</div><div class="line-number">4</div><div class="line-number">5</div><div class="line-number">6</div><div class="line-number">7</div><div class="line-number">8</div><div class="line-number">9</div><div class="line-number">10</div><div class="line-number">11</div><div class="line-number">12</div><div class="line-number">13</div><div class="line-number">14</div><div class="line-number">15</div><div class="line-number">16</div><div class="line-number">17</div><div class="line-number">18</div><div class="line-number">19</div><div class="line-number">20</div><div class="line-number">21</div><div class="line-number">22</div><div class="line-number">23</div><div class="line-number">24</div><div class="line-number">25</div><div class="line-number">26</div><div class="line-number">27</div><div class="line-number">28</div><div class="line-number">29</div><div class="line-number">30</div><div class="line-number">31</div><div class="line-number">32</div><div class="line-number">33</div><div class="line-number">34</div><div class="line-number">35</div><div class="line-number">36</div><div class="line-number">37</div><div class="line-number">38</div><div class="line-number">39</div><div class="line-number">40</div><div class="line-number">41</div><div class="line-number">42</div><div class="line-number">43</div><div class="line-number">44</div><div class="line-number">45</div></code></pre></td><td class="code"><pre><code><div class="line">data:text/html,</div><div class="line"><span class="xml"><span class="tag">&lt;<span class="title">style</span> <span class="attribute">type</span>=<span class="value">"text/css"</span>&gt;</span><span class="css"></div><div class="line"><span class="id">#e</span> <span class="rules">{</div><div class="line">  <span class="rule"><span class="attribute">position</span>:<span class="value">absolute;</span></span></div><div class="line">  <span class="rule"><span class="attribute">top</span>:<span class="value"><span class="number">0</span>;</span></span></div><div class="line">  <span class="rule"><span class="attribute">right</span>:<span class="value"><span class="number">0</span>;</span></span></div><div class="line">  <span class="rule"><span class="attribute">bottom</span>:<span class="value"><span class="number">0</span>;</span></span></div><div class="line">  <span class="rule"><span class="attribute">left</span>:<span class="value"><span class="number">0</span>;</span></span></div><div class="line">  <span class="rule"><span class="attribute">font-size</span>:<span class="value"><span class="number">16</span>px;</span></span></div><div class="line"><span class="rule">}</span></span></div><div class="line"></span><span class="tag">&lt;/<span class="title">style</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">id</span>=<span class="value">"e"</span>&gt;</span><span class="tag">&lt;/<span class="title">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"http://d1n0x3qji82z53.cloudfront.net/src-min-noconflict/ace.js"</span>&gt;</span><span class="undefined">&lt;/script&amp;gt;</div><div class="line">&lt;script src="http://code.jquery.com/jquery-1.9.0.min.js"&gt;&lt;/script&amp;gt;</div><div class="line">&lt;script&gt;</div><div class="line">var myKey="SecretKeyz";</div><div class="line">$(document).ready(function(){</div><div class="line">    var e = ace.edit("e");</div><div class="line">    var url = "http://api.openkeyval.org/"+myKey;</div><div class="line">    $.ajax({</div><div class="line">      url: url,</div><div class="line">      dataType: "jsonp",</div><div class="line">      success: function(data){</div><div class="line">       e.setTheme("ace/theme/tomorrow_night_eighties");</div><div class="line">       e.getSession().setMode("ace/mode/markdown");</div><div class="line">       e.setValue(data);</div><div class="line">      }</div><div class="line">    });</div><br><div class="line">    $("#e").on("keydown", function (b) {</div><div class="line">      if (b.ctrlKey &amp;&amp; 83 == b.which) {</div><div class="line">        b.preventDefault();</div><div class="line">        var data = myKey+"="+encodeURIComponent(e.getValue());</div><div class="line">        $.ajax({</div><div class="line">          data: data,</div><div class="line">          url: "http://api.openkeyval.org/store/",</div><div class="line">          dataType: "jsonp",</div><div class="line">          success: function(data){</div><div class="line">            alert("Saved.");</div><div class="line">          }</div><div class="line">        });</div><div class="line">      }</div><div class="line">    });</div><div class="line">});</div><div class="line"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span></span></div></code></pre></td></tr></table></figure>

<p>将以上代码完整复制，粘贴到 Chrome 或者 Firefox，Safari 浏览器地址栏中（不支持低版本 IE 浏览器），回车打开，稍等片刻一个支持 <code>CTRL</code> + <code>S</code>  保存内容的在线编辑器呈现眼前。</p>

<p>仅一行代码，实现功能相当于系统的记事本程序，感慨技术宅的艺术造诣吧？～</p>

<p><em>Update: 感谢 @问题青年a 提供 CoderWall 分享原文。</em></p>
        <div id="krapi"></div>
</div>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-01-31T08:59:12.000Z"><a href="/2013/01/31/node/">Jan 31 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/01/31/node/">关于express 3+中ejs模板的问题</a></h1>
  

    </header>
    <div class="entry">
      
        <div class="sep10"></div> 
<div class="topic_content">
<p>这个问题的主要原因是express3+中取消了ejs默认的模范如果需要使用需要如下操作：<br>安装</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line"><span class="title">npm</span> intall express-partials</div></code></pre></td></tr></table></figure>
<p>在app.js中加入</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div></code></pre></td><td class="code"><pre><code><div class="line"><span class="keyword">var</span> partials = <span class="keyword">require</span>(<span class="string">'express-partials'</span>);</div></code></pre></td></tr></table></figure>

<p>在app.configure()之中加入如下设置</p>

<figure class="highlight"><table><tr><td class="gutter"><pre><code><div class="line-number">1</div><div class="line-number">2</div></code></pre></td><td class="code"><pre><code><div class="line">app.set(<span class="attribute">'view</span> engine', <span class="attribute">'ejs</span>');</div><div class="line">app.<span class="keyword">use</span>(partials()); </div></code></pre></td></tr></table></figure>
<p>然后再在views目录中新建一个layout.ejs文件，然后就可以使用了。</p>
</div>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-01-31T07:09:39.000Z"><a href="/2013/01/31/appfog/">Jan 31 2013</a></time>
      
      
  
    <h1 class="title"><a href="/2013/01/31/appfog/">Appfog dot.tk namecheap搭建免费顶级域名动态dns站点</a></h1>
  

    </header>
    <div class="entry">
      
        <div class="media"><div class="media-body"><p class="p0">
    <strong><a href="https://www.appfog.com/" target="_blank">Appfog</a></strong> 
</p>
<p class="p0">
    &nbsp;&nbsp;&nbsp;&nbsp;2G<span>的免费空间和数据库支持，访问速度还可以，偶尔Appfog管理网站很卡&nbsp;<span>，总的说来相当之哈皮</span>！</span> 
</p>
<p class="p0">
    <span></span> 
</p>
<p class="p0">
    &nbsp;&nbsp;&nbsp;&nbsp;Appfog<span>支持的开发语言和框架：</span> 
</p>
<p class="p0">
    <span>&nbsp;&nbsp;&nbsp;&nbsp;<img src="http://res.cloudinary.com/ha1jeueli/image/upload/v1359208800/1359208799108.png" alt=""></span><span style="line-height:1.5;">&nbsp; &nbsp;&nbsp;</span> 
</p>
<p class="p0">
    <span></span> 
</p>
<p class="p0">
    &nbsp; &nbsp; 支持的数据库：
</p>
<p class="p0">
    &nbsp;&nbsp;&nbsp;&nbsp;<img src="http://res.cloudinary.com/ha1jeueli/image/upload/v1359208930/1359208929623.png" alt=""> 
</p>
<p class="p0">
    <br>
</p>
<p class="p0">
    &nbsp;&nbsp;&nbsp;&nbsp;以及丰富的第三方服务，这里就不一一列举了！
</p>
<p class="p0">
    &nbsp;&nbsp;&nbsp;&nbsp;前面已经介绍过日志<a href="http://www.dreamlu.net/blog/5" target="_blank">Logentries</a>和图片<a href="http://www.dreamlu.net/blog/6" target="_blank">Cloudinary</a>服务。
</p>
<p class="p0">
    &nbsp;&nbsp;&nbsp;&nbsp;详细文档：<a href="https://docs.appfog.com/"><a href="https://docs.appfog.com/&lt;/a&gt;">https://docs.appfog.com/&lt;/a&gt;</a> 
</p>
<p class="p0">
    <br>
</p>
<p class="p0" style="background:#FFFFFF;">
    <strong><a href="http://www.dot.tk/" target="_blank">Dot.tk</a></strong> 
</p>
<p class="p0" style="background:#FFFFFF;">
    &nbsp;&nbsp;&nbsp;&nbsp;.TK<span>是南太平洋岛国托克劳的国家域名</span>，免费注册一个帐户可以任意申请<span>.TK</span><span>域名，支持域名转发（可隐藏原</span><span>URL</span><span>）、电邮转发、</span><span>A</span><span>记录解析、</span><span>CNAME</span><span>。</span> 
</p>
<p class="p0" style="background:#FFFFFF;">
    &nbsp;&nbsp;&nbsp;&nbsp;并且<span>google</span><span>对</span><span>.tk</span><span>的收录并没有歧视，与其他顶级域名是一样</span>！
</p>
<p class="p0" style="background:#FFFFFF;">
    <br>
</p>
<p class="p0">
    <strong><a href="http://www.namecheap.com/" target="_blank">namecheap.com</a></strong> 
</p>
<p class="p0">
    <span>&nbsp;&nbsp;&nbsp;&nbsp;是一个</span><span>DNS</span><span>提供商，也提供免费服务。这个相比其他</span><span>DNS</span><span>提供商最大的优点就是可以自定义</span><span>TTL</span><span>，也就是</span><span>dns</span><span>更新频率，非常适合动态</span><span>IP</span><span>用户。</span> 
</p>
<p class="p0">
    <br>
</p>
<p class="p0">
    <strong>域名绑定和</strong><span><strong>dns</strong></span><span><strong>配置：</strong></span> 
</p>
<p class="p0">
    &nbsp; &nbsp; 1.&nbsp; &nbsp;&nbsp;<span style="line-height:1.5;">申请.tk域名</span> 
</p>
<p class="p0">
    &nbsp;&nbsp;&nbsp;&nbsp;<img src="http://res.cloudinary.com/ha1jeueli/image/upload/v1359209479/1359209479315.png" alt=""> 
</p>
<p class="p0">
    &nbsp; &nbsp; 2.&nbsp; &nbsp;&nbsp;<span style="line-height:1.5;">&nbsp;配置域名</span> 
</p>
<p class="p0">
    &nbsp; &nbsp;&nbsp;<span style="line-height:1.5;">本博已</span><span style="line-height:1.5;">snode.tk</span><span style="line-height:1.5;">和</span><a href="http://www.snode.tk">www.snode.tk</a><span style="line-height:1.5;">为例！</span> 
</p>
<p class="p0">
    &nbsp;&nbsp;&nbsp;&nbsp;<img src="http://res.cloudinary.com/ha1jeueli/image/upload/v1359209595/1359209595091.png" alt=""> 
</p>
<p class="p0">
    &nbsp; &nbsp;&nbsp;<span style="line-height:1.5;">第一个是域名转发，选择这个点</span><span style="line-height:1.5;">configure</span><span style="line-height:1.5;">，如果接下来在下面输入</span><a href="http://www.google.com/"><a href="http://www.google.com&lt;/a&gt;&lt;span">http://www.google.com&lt;/a&gt;&lt;span</a> style=&quot;line-height:1.5;&quot;&gt;那么当你访问</span><span style="line-height:1.5;">snode.tk的时候就会自动跳转到</span><span style="line-height:1.5;">Google</span><span style="line-height:1.5;">了。</span> 
</p>
<p class="p0" style="text-align:justify;">
    &nbsp;&nbsp;&nbsp;&nbsp;第二个是使用<span>dot.tk</span><span>本身的免费</span><span>Dns</span><span>服务，有</span><span>A</span><span>，</span><span>CNAME</span><span>，</span><span>MX</span><span>三个选项，可以设置很多子域名，要求不高可以自己用这个。</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;第三个就是我要说的重点了，我是这么设置的：<span>freedns1.registrar-servers.com</span><span>这三个就是</span><span>namecheap.com</span><span>提供的免费域名解析地址。</span> 
</p>
<p class="p0" style="text-align:justify;">
    <span> </span> 
</p>
<p class="p0">
    &nbsp;&nbsp;&nbsp;&nbsp;3.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;namecheap.com Dns<span>设置关联</span><span style="line-height:1.5;">&nbsp; &nbsp;</span> 
</p>
<p class="p0">
    <span> </span> 
</p>
<p class="p0">
    &nbsp;&nbsp;&nbsp;&nbsp;首先注册登录选择<span>FreeDns,</span><span>就是这个界面</span><span>,</span><span>输入我们要</span>绑定的域名snode.tk<span>点击</span><span>Next</span><span>，</span> 
</p>
<p class="p0">
    &nbsp;&nbsp;&nbsp;&nbsp;freedns1.registrar-servers.com<span>这几个出现了：</span> 
</p>
<p>
    <br>
</p>
<p class="p0">
    <span>&nbsp;&nbsp;&nbsp;&nbsp;<img src="http://res.cloudinary.com/ha1jeueli/image/upload/v1359209739/1359209738639.png" alt=""><br>
</span> 
</p>
<p class="p0">
    <span> </span> 
</p>
<p class="p0">
    &nbsp;&nbsp;&nbsp;&nbsp;点击“Free Dns”
</p>
<p class="p0">
    &nbsp;&nbsp;&nbsp;&nbsp;<img src="http://res.cloudinary.com/ha1jeueli/image/upload/v1359209883/1359209883310.png" alt=""> 
</p>
<p class="p0">
    &nbsp; &nbsp;&nbsp;<span style="line-height:1.5;">点击</span><span style="line-height:1.5;">“</span><span style="line-height:1.5;">Add&nbsp;DNS&nbsp;Service&nbsp;for&nbsp;Selected&nbsp;Domains</span><span style="line-height:1.5;">”</span> 
</p>
<p class="p0">
    &nbsp; &nbsp; 下一步“<span style="line-height:1.5;">Go&nbsp;to&nbsp;the&nbsp;Hosted&nbsp;Domains&nbsp;Page”<span>绑定ip</span>/url</span><span style="line-height:1.5;"></span> 
</p>
<p class="p0">
    &nbsp;&nbsp;&nbsp;&nbsp;<img src="http://res.cloudinary.com/ha1jeueli/image/upload/v1359210014/1359210014120.png" alt=""> 
</p>
<p class="p0">
    &nbsp;&nbsp;&nbsp;&nbsp;<span>绿色的用来添加，此处的</span><span>Ip/Url</span><span>从</span><span>Appfog</span><span>中获取！</span> 
</p>
<p class="p0">
    &nbsp;&nbsp;&nbsp;&nbsp;<img src="http://res.cloudinary.com/ha1jeueli/image/upload/v1359210144/1359210143882.png" alt=""> 
</p>
<p class="p0">
    &nbsp;&nbsp;&nbsp;&nbsp;<img src="http://res.cloudinary.com/ha1jeueli/image/upload/v1359210171/1359210171237.png" alt=""> 
</p>
<p class="p0">
    <br>
</p>
<p class="p0">
    设置要<span>30</span><span>分钟甚至几个小时才能生效</span>，稍安毋躁！
</p>
<p class="p0" style="background:#FFFCF6;">
    <strong>临渊羡鱼</strong><span><strong>,</strong></span><span><strong>不如退而结网</strong></span><span><strong>;</strong></span><span><strong>扬汤止沸</strong></span><span><strong>,</strong></span><span><strong>不如釜底抽薪</strong></span><strong>！</strong><span style="line-height:1.5;"></span> 
</p>
<p class="p0" style="background:#FFFCF6;">
    <br>
</p></div></div>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




<nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
<div class="search">
  <form action="http://google.com/search" method="get" accept-charset="utf-8">
    <input type="text" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:mac-deng.github.com">
  </form>
</div>




<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/appfog/">appfog</a><small>1</small></li>
  
    <li><a href="/tags/mongodb/">mongodb</a><small>1</small></li>
  
    <li><a href="/tags/node/">node</a><small>3</small></li>
  
    <li><a href="/tags/other/">other</a><small>1</small></li>
  
  </ul>
</div>



</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2013 mac
  
</div>
<div class="clearfix"></div></footer>
  <script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'macdeng';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>